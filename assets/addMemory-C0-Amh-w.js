import{r as s,u as L,j as e,c as J,C as U,B as v,a as E,A as B,T as R,P,b as _,S as X,d as q,e as z,L as T,f as F,g as Z}from"./vendor-BpQ4GIZC.js";import{M as G}from"./index-AR_LmOrU.js";const N=s.createContext(null),O=()=>{const o=s.useContext(N);if(!o)throw new Error("useAuth must be used within an AuthProvider");return o},$=({children:o})=>{const[t,u]=s.useState(()=>{const i=localStorage.getItem("user");return i?JSON.parse(i):null}),n=L();s.useEffect(()=>{t?localStorage.setItem("user",JSON.stringify(t)):localStorage.removeItem("user")},[t]);const p={user:t,isAuthenticated:!!t,login:(i,y)=>{const f={...y,type:i};u(f),n(i==="patient"?"/patient/dashboard":"/family/dashboard")},logout:()=>{u(null),n("/")}};return e.jsx(N.Provider,{value:p,children:o})},H="https://hvwvurqedrcmwuuwzkcg.supabase.co",K="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2d3Z1cnFlZHJjbXd1dXd6a2NnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0NDcxNDksImV4cCI6MjA1OTAyMzE0OX0.tsN9l5DkoHJin8xOGzikgcG5LhXkMXBbIEHtgRwas6o",d=J(H,K,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}),D=s.createContext(null),V=()=>{const o=s.useContext(D);if(!o)throw new Error("useMemory must be used within a MemoryProvider");return o},ee=({children:o})=>{const{user:t}=O(),[u,n]=s.useState([]),[h,m]=s.useState(!0),[p,i]=s.useState(null),[y,f]=s.useState(0),I=()=>{f(x=>x+1)};s.useEffect(()=>{(async()=>{if(!t){n([]),m(!1);return}try{m(!0),i(null);let l=t.id;t.type==="family"&&t.patient_id&&(l=t.patient_id);const{data:g,error:j}=await d.from("memories").select("*").eq("user_id",l).order("date",{ascending:!1});if(j)throw j;n(g||[])}catch(l){console.error("Error fetching memories:",l.message),i(l.message)}finally{m(!1)}})()},[t,y]);const a={memories:u,loading:h,error:p,triggerRefresh:I};return e.jsx(D.Provider,{value:a,children:o})},W=()=>{const o=L(),{user:t}=O(),{triggerRefresh:u}=V(),[n,h]=s.useState(0),[m,p]=s.useState(!1),[i,y]=s.useState(""),[f,I]=s.useState([]),[a,x]=s.useState({title:"",description:"",content:"",date:new Date().toISOString().split("T")[0],type:"text",people:[],filter:"none",location:""});s.useEffect(()=>{(async()=>{try{const{data:{user:c}}=await d.auth.getUser();if(!c)return;let w=c.id;if((t==null?void 0:t.type)==="family"){const{data:C,error:k}=await d.from("family_members").select("patient_id").eq("id",c.id).single();if(k)throw k;w=C.patient_id}const{data:b,error:S}=await d.from("memories").select("location").eq("user_id",w).not("location","is",null).not("location","eq","").order("created_at",{ascending:!1}).limit(10);if(S)throw S;const M=[...new Set(b.map(C=>C.location))];I(M)}catch(c){console.error("Error fetching recent locations:",c.message)}})()},[t]);const l=r=>{x(c=>({...c,location:r}))},g=["Create Memory","Add Details","Review & Save"],j=async()=>{if(n===g.length-1)try{const{data:{user:r},error:c}=await d.auth.getUser();if(c||!r)throw new Error("User not authenticated! Please log in.");let w=r.id;if((t==null?void 0:t.type)==="family"){const{data:S,error:M}=await d.from("family_members").select("patient_id").eq("id",r.id).single();if(M||!S)throw new Error("Could not find connected patient");w=S.patient_id}const{error:b}=await d.from("memories").insert([{user_id:w,title:a.title,description:a.description,content:a.content,date:a.date,type:a.type,location:a.location,people:a.people,filter:a.filter}]);if(b)throw b;u(),p(!0),setTimeout(()=>{(t==null?void 0:t.type)==="family"?o("/family/dashboard"):o("/patient/dashboard")},2e3)}catch(r){y(r.message)}else h(r=>r+1)},A=()=>{n===0?o(-1):h(r=>r-1)};return e.jsx(U,{maxWidth:"md",sx:{mt:2,mb:4},children:e.jsxs(v,{sx:{width:"100%"},children:[e.jsxs(v,{sx:{display:"flex",alignItems:"center",mb:4},children:[e.jsx(E,{startIcon:e.jsx(B,{}),onClick:A,sx:{mr:2},children:"Back"}),e.jsx(R,{variant:"h4",children:"Add New Memory"})]}),e.jsx(P,{elevation:2,sx:{p:3,borderRadius:3},children:m?e.jsx(_,{severity:"success",children:"Memory saved successfully! Redirecting..."}):e.jsxs(e.Fragment,{children:[e.jsx(X,{activeStep:n,sx:{mb:4},children:g.map(r=>e.jsx(q,{children:e.jsx(z,{children:r})},r))}),i&&e.jsx(_,{severity:"error",sx:{mb:3},children:i}),n===1&&f.length>0&&e.jsxs(v,{sx:{mb:3},children:[e.jsxs(R,{variant:"subtitle1",gutterBottom:!0,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(T,{color:"primary"}),"Recent Locations"]}),e.jsx(F,{direction:"row",spacing:1,flexWrap:"wrap",gap:1,children:f.map((r,c)=>e.jsx(Z,{label:r,onClick:()=>l(r),color:a.location===r?"primary":"default",variant:a.location===r?"filled":"outlined"},c))})]}),e.jsx(G,{memoryData:a,setMemoryData:x}),e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",mt:4},children:[e.jsx(E,{variant:"outlined",onClick:A,sx:{borderRadius:2},children:"Back"}),e.jsx(E,{variant:"contained",color:"primary",onClick:j,sx:{borderRadius:2},children:n===g.length-1?"Save Memory":"Next"})]})]})})]})})},te=Object.freeze(Object.defineProperty({__proto__:null,default:W},Symbol.toStringTag,{value:"Module"}));export{$ as A,ee as M,te as a,d as s,O as u};
